/* Copyright (c) 2022 Advanced Micro Devices, Inc. All rights reserved. */

// =============================================================================
// WARNING!  WARNING!  WARNING!  WARNING!  WARNING!  WARNING!  WARNING!
//
// This code was auto-generated by settings_codegen.py. Do not modify manually.
// =============================================================================

#include "{{CodeGenHeader}}"
#include <{{SettingsHeader}}>

#include <devDriverServer.h>
#include <protocols/ddSettingsService.h>
{% if UseRpc %}
#include <ddSettingsService.h>
{% endif %}
#include <ddSettingsTypes.h>

{% if PalSettings %}
#include "palInlineFuncs.h"
#include "core/device.h"
{% endif %}

using namespace DevDriver::SettingsURIService;

{% macro prep_cond_begin(prep_cond) %}
{% if prep_cond %}
{{prep_cond}}
{% endif %}
{% endmacro %}
{# ======================================== #}
{% macro prep_cond_end(prep_cond) %}
{% if prep_cond %}
#endif
{% endif %}
{% endmacro %}

namespace {{Namespace}}
{

// =======================================================================================
const char* {{ClassName}}::GetComponentName() const
{
    return "{{ComponentName}}";
}

// =======================================================================================
uint64_t {{ClassName}}::GetComponentHash() const
{
    return (uint64_t){{SettingsBlobHash|abs}}ULL;
}

// =======================================================================================
// Initializes the settings structure to default values.
void {{ClassName}}::SetupDefaults()
{
{% for setting in Settings %}
{% if setting.GroupName %}

{% for subs in setting.Subsettings %}
{{ prep_cond_begin(subs.BuildFilters) -}}
{{ subs|setup_default(setting.GroupVariableName) -}}
{{ prep_cond_end(subs.BuildFilters) -}}
{% endfor %}
{% else %}
{{ prep_cond_begin(setting.BuildFilters) -}}
{{ setting|setup_default('') -}}
{{ prep_cond_end(setting.BuildFilters) -}}
{% endif %}
{% endfor %}
}

// =======================================================================================
// Initializes the SettingInfo hash map and array of setting hashes.
void {{ClassName}}::InitSettingsInfo()
{
    using namespace DevDriver;

    DDSettingsValueRef valueRef = {};
{% for setting in Settings %}
{% if setting.GroupName %}

{% for subs in setting.Subsettings %}
{{ prep_cond_begin(subs.BuildFilters) }}
    valueRef.type = {{ subs.Defaults.Type|setting_type_cpp }};
    valueRef.pVal = &m_settings.{{setting.GroupVariableName}}.{{subs.VariableName}};
    valueRef.size = sizeof(m_settings.{{setting.GroupVariableName}}.{{subs.VariableName}});
    m_settingsMap.Insert({{subs.NameHash}}, valueRef);
{{ prep_cond_end(subs.BuildFilters) -}}
{% endfor %}
{% else %}
{{ prep_cond_begin(setting.BuildFilters) }}
    valueRef.type = {{ setting.Defaults.Type|setting_type_cpp }};
    valueRef.pVal = &m_settings.{{setting.VariableName}};
    valueRef.size = sizeof(m_settings.{{setting.VariableName}});
    m_settingsMap.Insert({{setting.NameHash}}, valueRef);
{{ prep_cond_end(setting.BuildFilters) -}}
{% endif %}
{% endfor %}
}

{% if PalSettings %}
// =======================================================================================
// Read settings from registry for PAL settings.
void {{ClassName}}::ReadSettings(Pal::Device* pDevice)
{
{% for setting in Settings %}
{% if setting.GroupName %}

{% for subs in setting.Subsettings %}
{{ prep_cond_begin(subs.BuildFilters) }}
    pDevice->ReadSetting(
        p{{setting.GroupName}}_{{subs.Name}}HashStr,
        {{ subs.Defaults.Type|setting_type_cpp2 }},
        &m_settings.{{setting.GroupVariableName}}.{{subs.VariableName}},
        InternalSettingScope::{{setting.Scope|default('PrivatePalKey')}});
{{ prep_cond_end(subs.BuildFilters) -}}
{% endfor %}
{% else %}
{{ prep_cond_begin(setting.BuildFilters) }}
    pDevice->ReadSetting(
        p{{setting.Name}}HashStr,
        {{ setting.Defaults.Type|setting_type_cpp2 }},
        &m_settings.{{setting.VariableName}},
        InternalSettingScope::{{setting.Scope|default('PrivatePalKey')}});
{{ prep_cond_end(setting.BuildFilters) -}}
{% endif %}
{% endfor %}
}
{% endif %}

{% if DxcSettings %}
// =======================================================================================
// Read settings from registry for DXCP settings.
void {{ClassName}}::ReadSettings(DdiAdapter* pAdapter)
{
    (void)pAdapter;
}
{% endif %}

// =======================================================================================
// SettingsBlob implementation

const uint8_t* {{ComponentName}}SettingsBlobNode::GetBlob(uint32_t* pOutSize)
{
    static const uint8_t s_settingsBlob[] = {
        {{SettingsBlob}}
    };

    static_assert({{SettingsBlobSize}} == sizeof(s_settingsBlob),
        "Settings YAML data size in C++ doesn't match the one calculated "
        "in the codegen script."
    );

    *pOutSize = sizeof(s_settingsBlob);

    return s_settingsBlob;
}

bool {{ComponentName}}SettingsBlobNode::IsEncoded()
{
    return {{Encoded|string|lower}};
}

uint64_t {{ComponentName}}SettingsBlobNode::GetBlobHash()
{
    return (uint64_t){{SettingsBlobHash|abs}}ULL;
}

{{ComponentName}}SettingsBlobNode g_{{ComponentNameLower}}SettingsBlobNode;

} // namespace {{Namespace}}
